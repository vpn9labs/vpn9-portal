#!/usr/bin/env bash
set -euo pipefail

# VPN9 Portal Deployment Script
# Build metadata is calculated in .kamal/secrets

echo "=== VPN9 Portal Deployment ==="
echo ""

# Check for uncommitted changes
if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "Committing working changes before deployment..."
  git add -A
  git commit -m "Deploy: Auto-commit working changes for build metadata" || true
  echo ""
fi

# Calculate and export build metadata
export BUILD_VERSION=$(git describe --tags --always 2>/dev/null || echo "v0.0.1-$(git rev-parse --short HEAD)")
export BUILD_COMMIT=$(git rev-parse HEAD)
export BUILD_TIMESTAMP=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
export SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)

echo "Build Metadata:"
echo "  VERSION: ${BUILD_VERSION}"
echo "  COMMIT: ${BUILD_COMMIT:0:8}"
echo "  TIMESTAMP: ${BUILD_TIMESTAMP}"
echo ""

# Deploy with Kamal (will use exported env vars for empty args)
echo "Deploying with Kamal..."
OP_ACCOUNT=zajpt kamal deploy

echo ""
echo "=== Deployment Complete ==="
echo ""
echo "Waiting for service to stabilize..."
sleep 15

# Verify deployment
echo "Verifying deployment..."
RESPONSE=$(curl -s https://vpn9.com/api/v1/attestation 2>/dev/null || echo "{}")

if [ -n "$RESPONSE" ] && [ "$RESPONSE" != "{}" ]; then
  DEPLOYED_VERSION=$(echo "$RESPONSE" | jq -r '.deployment.build_version' 2>/dev/null || echo "unknown")
  DEPLOYED_COMMIT=$(echo "$RESPONSE" | jq -r '.deployment.build_commit' 2>/dev/null || echo "unknown")

  echo "Deployed version: ${DEPLOYED_VERSION}"
  echo "Deployed commit: ${DEPLOYED_COMMIT:0:8}"

  if [ "$DEPLOYED_VERSION" = "$BUILD_VERSION" ]; then
    echo ""
    echo "✅ Success! Build metadata verified."
  else
    echo ""
    echo "⚠️  Build metadata may take a moment to propagate."
    echo "   Expected: ${BUILD_VERSION}"
    echo "   Got: ${DEPLOYED_VERSION}"
  fi
fi

echo ""
echo "View at: https://vpn9.com/verify"

